---
title: 简单理解MySQL的sql查询执行过程
date: 2019-09-18 17:22:34
tags:
- 数据库
- MySQL
---
# Introduction

日常工作中一般我们都需要和DB打交道，作为一个有强迫症的工程师（我认为也是成为优秀工程师的必要特质），我本人是非常想知道我写的每个sql，它的实际性能如何？在实现基本业务需求的前提下，它是不是各种实现方式的最优解？想知道这些，你当然需要知道一条sql语句在实际执行过程中是如何被解析并运行返回结果的。最近也读了些文章和订阅的专栏来了解这方面知识，这篇文章作为一个开篇来简单谈谈我的理解。

# Framework
![MySQL逻辑架构][image-1]
这个架构我是摘自极客时间丁奇的一个订阅付费的专栏，专门介绍mysql的，我觉得讲的蛮好，大家有兴趣也可以读读。
Mysql从大块上来划分，主要就是Server层和存储层。Server层又可以拆解成连接器、分析器、优化器和执行器，下面依次谈下我对这几个组件的理解。
## 连接器
这个组件的主要作用是和客户端进行交互，完成权限验证操作（如我们的每次登陆mysql -h -u -p，连接器会去user表中查询输入的用户名密码是否有效)。
在完成登陆操作后，客户端和MySQL Server的一条连接就成功建立了（TCP握手）。连接后如果没有后续的CRUD，那么这个连接就是空闲状态，通常这个连接不会一直保持，超过一定时间，连接器就会自动将它断开。这个时间默认是8小时。
数据库连接可以分为长连接和短连接。长连接指客户端持续的请求一直使用同一个连接，短连接指请求执行短时间的一个或几个查询后就断开连接。数据库连接的建立是一个非常耗时的操作，理论上使用长连接能获得更好的查询性能，但长连接也会存在问题，我在这里引用丁奇专栏里的内容，感觉讲的还比较清楚：
> 但是全部使用长连接后，你可能会发现，有些时候 MySQL 占用内存飙升，这是因为MySQL在执行过程中临时使用的内存是管理在连接对象里面的。这些资源在连接断开时会得到释放。长连接积累下来，可能导致内存占用太大，被系统强行杀掉，从现象看就是MySQL异常重启了。
> 解决这个问题有两个方案：
> 1. 定期断开长连接。
> 2.  MySQL5.7以上的版本，可以执行mysql_reset_connection来重新初始化连接资源。这个过程不需要重连和权限验证，但会将连接恢复到刚刚创建时的状态。

## 分析器

词法分析&语法分析，如识别"select * from t1 where id = 1*”中的select是一个查询语句，from后面的t1是一个表名等等。

## 优化器

优化器主要用于决定命中索引以及多表join时各个表的连接顺序。

## 执行器

执行器是Server与存储引擎交互的部分，MySQL的存储引擎是类似插件式的实现方式，不同的存储引擎只需对Server层暴露对应的api即可。执行的步骤以上述sql为例，就是不断调用对应引擎的接口获得表的第n行，判断该行的id是否为1，是则存储到结果集，遍历完成后将结果集返回给客户端即可。

# Summary

简单总结下一条sql查询的执行过程：
1. 客户端发送一条sql查询语句
2. Server层判断缓存中是否存在对应sql的key，是则直接返回结果给客户端，否则继续执行
3. Server调用分析器进行词法&语法分析，对于不满足语法条件的sql语句直接抛出异常返回给客户端
4. Server调用优化器来决定使用的索引以及多表关联的顺序
5. Server调用执行器去存储引擎查找数据，将符合查询条件的数据返回给客户端

[image-1]:	https://myblog-1259548259.cos.ap-beijing.myqcloud.com/mysql_framework.png "MySQL逻辑架构"